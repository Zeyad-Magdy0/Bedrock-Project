# ============================================================
# Phase 1 Validation â€” Kubernetes Node Eligibility Contract
# ============================================================


# ------------------------------------------------------------
# OS & Resource Validation
# ------------------------------------------------------------

- name: Validate OS is Ubuntu 22.04
  assert:
    that:
      - ansible_distribution == "Ubuntu"
      - ansible_distribution_version is version("22.04", ">=")
    fail_msg: "Unsupported OS. Ubuntu 22.04 required."

- name: Validate minimum CPU (2 vCPU)
  assert:
    that:
      - ansible_processor_vcpus | int >= 2
    fail_msg: "CPU below required minimum (2 vCPU)."

- name: Validate minimum memory (4GB)
  assert:
    that:
      - ansible_memtotal_mb | int >= 3096
    fail_msg: "Memory below required minimum (4GB)."


# ------------------------------------------------------------
# Swap Validation
# ------------------------------------------------------------

- name: Validate swap is disabled
  assert:
    that:
      - ansible_swaptotal_mb | int == 0
    fail_msg: "Swap is enabled. Kubernetes eligibility violated."


# ------------------------------------------------------------
# Kernel Modules Validation
# ------------------------------------------------------------

- name: Get loaded kernel modules
  command: lsmod
  register: lsmod_output
  changed_when: false

- name: Validate required kernel modules are loaded
  assert:
    that:
      - "'overlay' in lsmod_output.stdout"
      - "'br_netfilter' in lsmod_output.stdout"
    fail_msg: "Required kernel modules not loaded."


# ------------------------------------------------------------
# Sysctl Validation
# ------------------------------------------------------------

- name: Validate net.ipv4.ip_forward
  command: sysctl -n net.ipv4.ip_forward
  register: ip_forward_check
  changed_when: false

- assert:
    that:
      - ip_forward_check.stdout == "1"
    fail_msg: "net.ipv4.ip_forward is not set to 1."

- name: Validate net.bridge.bridge-nf-call-iptables
  command: sysctl -n net.bridge.bridge-nf-call-iptables
  register: bridge_check
  changed_when: false

- assert:
    that:
      - bridge_check.stdout == "1"
    fail_msg: "net.bridge.bridge-nf-call-iptables is not set to 1."


# ------------------------------------------------------------
# Time Sync Validation
# ------------------------------------------------------------

- name: Validate systemd-timesyncd is active
  systemd:
    name: systemd-timesyncd
  register: timesync_status
  changed_when: false
  failed_when: timesync_status.status.ActiveState != "active"


# ------------------------------------------------------------
# Container Runtime Validation
# ------------------------------------------------------------

- name: Ensure containerd service is active
  systemd:
    name: containerd
  register: containerd_status
  changed_when: false
  failed_when: containerd_status.status.ActiveState != "active"

- name: Verify containerd socket exists
  stat:
    path: /run/containerd/containerd.sock
  register: containerd_socket_stat

- name: Validate containerd socket presence
  assert:
    that:
      - containerd_socket_stat.stat.exists
    fail_msg: "Containerd socket not found."


# ------------------------------------------------------------
# Phase 1 Validation Complete
# ------------------------------------------------------------