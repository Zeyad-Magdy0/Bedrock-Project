---
# =====================================================
# Install Local Path Storage Provisioner
# =====================================================

- name: Check if local-path namespace exists
  ansible.builtin.command: kubectl get ns local-path-storage
  register: local_path_ns
  failed_when: false
  changed_when: false
  environment:
    KUBECONFIG: "{{ kube_admin_conf }}"

- name: Install local-path storage provisioner
  ansible.builtin.command: >
    kubectl apply -f
    https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
  when: local_path_ns.rc != 0
  register: local_path_apply
  changed_when: "'created' in local_path_apply.stdout or 'configured' in local_path_apply.stdout"
  environment:
    KUBECONFIG: "{{ kube_admin_conf }}"

# =====================================================
# Wait for Provisioner to be Ready
# =====================================================

- name: Wait for local-path-provisioner pod to be ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    -l app=local-path-provisioner
    -n local-path-storage
    --timeout=180s
  changed_when: false
  environment:
    KUBECONFIG: "{{ kube_admin_conf }}"

# =====================================================
# Ensure local-path is Default StorageClass
# =====================================================

- name: Check current default storageclass
  ansible.builtin.command: >
    kubectl get storageclass
    -o jsonpath='{range .items[*]}{.metadata.name}{"="}{.metadata.annotations.storageclass\.kubernetes\.io/is-default-class}{"\n"}{end}'
  register: storageclasses
  changed_when: false
  environment:
    KUBECONFIG: "{{ kube_admin_conf }}"

- name: Set local-path as default storageclass
  ansible.builtin.command: >
    kubectl patch storageclass local-path
    -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
  when: "'local-path=true' not in storageclasses.stdout"
  changed_when: true
  environment:
    KUBECONFIG: "{{ kube_admin_conf }}"