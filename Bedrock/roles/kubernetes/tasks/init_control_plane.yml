---
# ============================================================
# CONTROL PLANE INIT — SINGLE FILE, FULL STATE MACHINE
# ============================================================

# ------------------------------------------------------------
# 1️⃣ Detect structural state
# ------------------------------------------------------------

- name: Check if admin.conf exists
  stat:
    path: /etc/kubernetes/admin.conf
  register: admin_conf_stat


# ------------------------------------------------------------
# 2️⃣ If cluster exists, check runtime health
# ------------------------------------------------------------

- name: Check API health (if initialized)
  command: kubectl get --raw=/healthz
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: api_health
  failed_when: false
  changed_when: false
  when: admin_conf_stat.stat.exists


- name: Check etcd health (if initialized)
  shell: |
    ETCDCTL_API=3 etcdctl \
      --cacert=/etc/kubernetes/pki/etcd/ca.crt \
      --cert=/etc/kubernetes/pki/etcd/server.crt \
      --key=/etc/kubernetes/pki/etcd/server.key \
      endpoint health
  register: etcd_health
  failed_when: false
  changed_when: false
  when: admin_conf_stat.stat.exists


# ------------------------------------------------------------
# 4️⃣ Perform full rebuild if needed [Critical Need Manual Intervention]
# ------------------------------------------------------------

- name: Full control-plane rebuild
  block:

    - name: Stop kubelet
      systemd:
        name: kubelet
        state: stopped

    - name: Reset cluster
      command: kubeadm reset -f
      ignore_errors: true

    - name: Remove Kubernetes state
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/etcd
        - /var/lib/kubelet
        - /var/lib/cni
        - /etc/cni

    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted

    - name: Start kubelet
      systemd:
        name: kubelet
        state: started

    - name: Initialize control plane
      command: >
        kubeadm init
        --apiserver-advertise-address={{ ansible_facts['default_ipv4']['address'] }}
        --pod-network-cidr={{ pod_network_cidr }}
        --kubernetes-version=v{{ init_k8s_version }}
      register: kubeadm_init

  when: build_required | default(false) | bool


# ------------------------------------------------------------
# 5️⃣ Wait for static control-plane pods
# ------------------------------------------------------------

- name: Wait for kube-apiserver running
  shell: crictl ps | grep kube-apiserver | grep Running
  register: apiserver_running
  retries: 30
  delay: 5
  until: apiserver_running.rc == 0
  changed_when: false


- name: Wait for kube-controller-manager running
  shell: crictl ps | grep kube-controller-manager | grep Running
  register: controller_running
  retries: 30
  delay: 5
  until: controller_running.rc == 0
  changed_when: false


- name: Wait for kube-scheduler running
  shell: crictl ps | grep kube-scheduler | grep Running
  register: scheduler_running
  retries: 30
  delay: 5
  until: scheduler_running.rc == 0
  changed_when: false


# ------------------------------------------------------------
# 6️⃣ Wait for API readiness
# ------------------------------------------------------------

- name: Wait for API server health
  command: kubectl get --raw=/healthz
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: api_ready
  retries: 30
  delay: 5
  until: api_ready.rc == 0
  changed_when: false


# ------------------------------------------------------------
# 7️⃣ Verify node is registered
# ------------------------------------------------------------

- name: Wait for node to appear Ready
  command: kubectl get nodes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: node_status
  retries: 20
  delay: 5
  until: "'Ready' in node_status.stdout"
  changed_when: false

  